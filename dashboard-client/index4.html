<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Dashboard - Modern Interface</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Enhanced Color Palette - Modern Dark/Light Theme */
            --primary-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-bg: #f8fafc;
            --card-bg: #ffffff;
            --card-bg-hover: #fefefe;
            --card-border: rgba(226, 232, 240, 0.8);
            --card-shadow: 0 4px 25px rgba(0, 0, 0, 0.08);
            --card-shadow-hover: 0 8px 40px rgba(0, 0, 0, 0.15);
            
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-accent: #3b82f6;
            --text-muted: #94a3b8;
            
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            
            --border-color: #e2e8f0;
            --divider-color: #f1f5f9;
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-card: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            --gradient-accent: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            
            /* Spacing & Sizing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            --border-radius-sm: 6px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 24px;
            
            /* Animation */
            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background: var(--primary-bg);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
        }

        /* Header Section */
        .header-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: var(--spacing-lg) var(--spacing-xl);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.25rem;
            font-weight: 700;
            margin: 0;
            text-align: center;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.025em;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 1rem;
            margin-top: var(--spacing-sm);
            font-weight: 400;
        }

        /* Main Content Container */
        .main-content {
            padding: var(--spacing-xl);
            background: var(--secondary-bg);
            min-height: calc(100vh - 140px);
        }

        /* Dashboard Grid */
        .dashboard-container {
            display: grid;
            gap: var(--spacing-xl);
            grid-template-columns: 1fr;
            max-width: 1400px;
            margin: 0 auto;
        }

        @media (min-width: 768px) {
            .dashboard-container {
                grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            }
        }

        @media (min-width: 1200px) {
            .dashboard-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Enhanced Card Styling */
        .card {
            background: var(--gradient-card);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xl);
            box-shadow: var(--card-shadow);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-accent);
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--card-shadow-hover);
            background: var(--card-bg-hover);
        }

        /* Card Titles */
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0 0 var(--spacing-lg) 0;
            color: var(--text-primary);
            text-align: left;
            position: relative;
            padding-left: var(--spacing-md);
        }

        .card-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 20px;
            background: var(--gradient-accent);
            border-radius: var(--border-radius-sm);
        }

        /* Chart Containers */
        .chart-js-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9;
            min-height: 240px;
            margin-bottom: var(--spacing-lg);
            border-radius: var(--border-radius-md);
            overflow: hidden;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chart-js-container:last-child {
            margin-bottom: 0;
        }

        /* Bubble Chart Styling */
        .bubble-chart-container {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
            width: 100%;
        }

        .bubble-chart-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 4 / 3;
            min-height: 280px;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .bubble-chart-wrapper p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: center;
            margin: 0 0 var(--spacing-sm) 0;
            font-weight: 500;
            padding: var(--spacing-sm);
            background: rgba(59, 130, 246, 0.1);
            border-radius: var(--border-radius-md) var(--border-radius-md) 0 0;
        }

        /* 3D Radar Styling */
        #radar3D {
            width: 100%;
            min-height: 350px;
            aspect-ratio: 1 / 0.8;
            border-radius: var(--border-radius-md);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        /* Map Styling */
        #map {
            min-height: 350px;
            aspect-ratio: 1 / 0.8;
            width: 100%;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: #e0e0e0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Info Section Styling */
        .info-section {
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--divider-color);
            background: rgba(255, 255, 255, 0.3);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-lg);
            backdrop-filter: blur(5px);
        }

        #radarValues {
            text-align: center;
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 600;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--spacing-sm);
        }

        p.radar-info {
            margin: var(--spacing-sm) 0;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-muted);
            font-style: italic;
        }

        /* Status Messages */
        .status-message {
            padding: var(--spacing-md) var(--spacing-lg);
            margin: 0 0 var(--spacing-lg) 0;
            text-align: center;
            font-weight: 500;
            border-radius: var(--border-radius-md);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.9);
            color: white;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.9);
            color: white;
        }

        /* Map Error Overlay */
        #map-error-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(239, 68, 68, 0.95);
            color: white;
            padding: var(--spacing-sm);
            text-align: center;
            z-index: 1000;
            font-size: 0.85rem;
            border-radius: var(--border-radius-md) var(--border-radius-md) 0 0;
            backdrop-filter: blur(10px);
        }

        /* Responsive Grid Adjustments */
        @media (min-width: 992px) {
            .card:has(> .chart-js-container + .chart-js-container) {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: var(--spacing-lg);
                align-items: start;
            }

            .card:has(> .chart-js-container + .chart-js-container) > .chart-js-container {
                margin-bottom: 0;
            }

            .bubble-chart-container {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: var(--spacing-lg);
            }
        }

        /* Mobile Optimizations */
        @media (max-width: 767px) {
            .main-content {
                padding: var(--spacing-lg);
            }

            .dashboard-container {
                gap: var(--spacing-lg);
            }

            .card {
                padding: var(--spacing-lg);
            }

            .card-title {
                font-size: 1.1rem;
            }

            .chart-js-container,
            .bubble-chart-wrapper {
                aspect-ratio: 16 / 10;
                min-height: 220px;
            }

            #map, #radar3D {
                min-height: 280px;
                aspect-ratio: 1 / 0.7;
            }

            h1 {
                font-size: 1.75rem;
            }
        }

        /* Loading States */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Enhanced Leaflet Controls */
        #map .leaflet-popup-content-wrapper {
            border-radius: var(--border-radius-md);
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        #map .leaflet-popup-content {
            font-size: 0.9rem;
            font-weight: 500;
        }

        #map .leaflet-control-zoom,
        #map .leaflet-control-scale {
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            box-shadow: var(--card-shadow) !important;
            backdrop-filter: blur(10px) !important;
            border-radius: var(--border-radius-sm) !important;
        }

        /* Plotly Chart Theming */
        .js-plotly-plot .plotly .bg {
            fill: rgba(255, 255, 255, 0.8) !important;
        }

        .js-plotly-plot .plotly .gridlayer .grid path {
            stroke: var(--border-color) !important;
        }

        .js-plotly-plot .plotly .zeroline {
            stroke: var(--text-secondary) !important;
        }

        .js-plotly-plot .plotly text {
            fill: var(--text-secondary) !important;
            font-family: 'Inter', sans-serif !important;
        }

        /* Canvas Styling */
        canvas {
            border-radius: var(--border-radius-sm);
        }

        /* Accessibility Improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            .card {
                transform: none !important;
            }
        }

        /* Focus States */
        .card:focus-within {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        /* High Contrast Support */
        @media (prefers-contrast: high) {
            :root {
                --card-border: #000000;
                --text-secondary: #000000;
                --card-shadow: 0 4px 25px rgba(0, 0, 0, 0.25);
            }
        }
    </style>
</head>
<body>
    <header class="header-section">
        <h1>IoT Dashboard</h1>
        <p class="subtitle">Real-time Monitoring & Visualization</p>
    </header>

    <main class="main-content">
        <div class="dashboard-container">

            <div class="card">
                <h3 class="card-title">Vị trí</h3>
                <div id="map">Đang tải bản đồ...</div>
            </div>

            <div class="card">
                <h3 class="card-title">Trực quan hóa Radar 3D (Plotly)</h3>
                <div id="radar3D"></div>
                <div class="info-section">
                    <div id="radarValues">Tọa độ: N/A</div>
                    <p class="radar-info">Phòng: 500x500x500 - Gốc (0,0,0) ở trên, Z hướng xuống</p>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Lịch sử Tọa độ</h3>
                <div class="chart-js-container"> <canvas id="xChart"></canvas> </div>
                <div class="chart-js-container"> <canvas id="yChart"></canvas> </div>
                <div class="chart-js-container"> <canvas id="zChart"></canvas> </div>
            </div>

            <div class="card">
                <h3 class="card-title">Tương quan Tọa độ Tức thời</h3>
                <div class="bubble-chart-container">
                    <div class="bubble-chart-wrapper"> <p><b>YX</b> (Trục tung ~ X(t))</p> <canvas id="yxBubbleChart"></canvas> </div>
                    <div class="bubble-chart-wrapper"> <p><b>ZY</b> (Trục tung ~ Y(t))</p> <canvas id="zyBubbleChart"></canvas> </div>
                    <div class="bubble-chart-wrapper"> <p><b>XZ</b> (Trục tung ~ Z(t))</p> <canvas id="xzBubbleChart"></canvas> </div>
                </div>
            </div>

        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Constants and Config ---
            const MAX_HISTORY_POINTS = 30;
            const ROOM_SIZE = 500;
            const MIN_RADIUS = 0.5;
            const MAX_RADIUS = 50;
            const MIN_POINT_RADIUS = 2;
            const MAX_POINT_RADIUS = 8;
            const chartColors = { x: 'rgb(255, 0, 0)', y: 'rgb(0, 255, 0)', z: 'rgb(0, 0, 255)'};
            const bubbleColorX = 'rgba(255, 0, 0, 0.6)';
            const bubbleColorY = 'rgba(0, 255, 0, 0.6)';
            const bubbleColorZ = 'rgba(0, 0, 255, 0.6)';
            const bubbleBorderColor = 'rgb(108, 117, 125)';

            // --- Global Variables ---
            let xChart, yChart, zChart;
            let yxBubbleChart, zyBubbleChart, xzBubbleChart;
            let map;
            let radarHistory = [];
            let radarPlotlyInitialized = false;

            // --- Helper Functions ---
            function mapRtoPointRadius(r) {
                const normalizedR = Math.max(0, Math.min(1, (r - MIN_RADIUS) / (MAX_RADIUS - MIN_RADIUS)));
                const pointRadius = MIN_POINT_RADIUS + normalizedR * (MAX_POINT_RADIUS - MIN_POINT_RADIUS);
                return Math.max(MIN_POINT_RADIUS, Math.min(MAX_POINT_RADIUS, pointRadius));
            }

            function convertRadiusToPlotlySize(r){
                const scale = (10 - 3) / (MAX_RADIUS - MIN_RADIUS);
                const offset = 3 - scale * MIN_RADIUS;
                return Math.max(3, scale * r + offset);
            }

            // --- Initialization Functions ---
            function initTimeSeriesCharts() {
                const commonOptions = (label, minVal, maxVal, showTime = true) => ({
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: {
                            ticks: { display: showTime, maxRotation: 0, autoSkip: true, maxTicksLimit: 6, font: { size: 9 } },
                            grid: { display: true }
                        },
                        y: {
                            title: { display: true, text: label, font: { size: 10 } },
                            min: minVal,
                            max: maxVal,
                            ticks: { stepSize: 100, font: { size: 9 } },
                            grid: { display: true }
                        }
                    },
                    plugins: { legend: { display: false }, tooltip: { bodyFont: { size: 10 }, titleFont: { size: 10 }, displayColors: false } }
                });

                const pointRadiusFunc = (context) => {
                    const idx = context.dataIndex;
                    return (context.dataset.pointRadii && context.dataset.pointRadii[idx]) || 0;
                };
                const pointOptions = { elements: { point: { radius: pointRadiusFunc, hoverRadius: ctx => pointRadiusFunc(ctx) + 2, borderWidth: 0 } } };

                const xCtx = document.getElementById('xChart')?.getContext('2d');
                const yCtx = document.getElementById('yChart')?.getContext('2d');
                const zCtx = document.getElementById('zChart')?.getContext('2d');
                let success = true;

                if(xCtx) xChart = new Chart(xCtx, { type: 'line', data: { labels: [], datasets: [{ label: 'X', data: [], borderColor: chartColors.x, borderWidth: 1.5, pointRadii: [] }] }, options: { ...commonOptions('X', 0, ROOM_SIZE), ...pointOptions } });
                else { console.error("xChart canvas not found"); success = false; }

                if(yCtx) yChart = new Chart(yCtx, { type: 'line', data: { labels: [], datasets: [{ label: 'Y', data: [], borderColor: chartColors.y, borderWidth: 1.5, pointRadii: [] }] }, options: { ...commonOptions('Y', 0, ROOM_SIZE), ...pointOptions } });
                else { console.error("yChart canvas not found"); success = false; }

                if(zCtx) zChart = new Chart(zCtx, { type: 'line', data: { labels: [], datasets: [{ label: 'Z', data: [], borderColor: chartColors.z, borderWidth: 1.5, pointRadii: [] }] }, options: { ...commonOptions('Z', 0, ROOM_SIZE), ...pointOptions } });
                else { console.error("zChart canvas not found"); success = false; }

                return success;
            }

            function initBubbleCharts() {
                 const commonBubbleOptions = (xLabel, yLabel, xMin, xMax, yMin, yMax) => ({
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        x: {
                            min: xMin,
                            max: xMax,
                            title: { display: true, text: xLabel, font: { size: 10 } },
                            ticks: { stepSize:100, font: { size: 9 } },
                            grid: { display: true }
                        },
                        y: {
                            min: yMin,
                            max: yMax,
                            title: { display: true, text: yLabel, font: { size: 10 } },
                            ticks: { stepSize: 100, font: { size: 9 } },
                            grid: { display: true }
                        }
                    },
                    plugins: { legend: { display: false }, tooltip: { enabled: true, callbacks: {} } }
                });

                 const tooltipCallback = (context) => {
                     const dataPoint = context.raw;
                     const lastHistory = radarHistory[radarHistory.length - 1];
                     let original_r = lastHistory ? lastHistory.r : 0;
                     if (context.chart.canvas.id === 'yxBubbleChart') return `Y: ${dataPoint.x.toFixed(1)}, X: ${dataPoint.y.toFixed(1)}, r: ${original_r.toFixed(1)}`;
                     if (context.chart.canvas.id === 'zyBubbleChart') return `Z: ${dataPoint.x.toFixed(1)}, Y: ${dataPoint.y.toFixed(1)}, r: ${original_r.toFixed(1)}`;
                     if (context.chart.canvas.id === 'xzBubbleChart') return `X: ${dataPoint.x.toFixed(1)}, Z: ${dataPoint.y.toFixed(1)}, r: ${original_r.toFixed(1)}`;
                     return '';
                 };

                 const yxCtx=document.getElementById('yxBubbleChart')?.getContext('2d');
                 const zyCtx=document.getElementById('zyBubbleChart')?.getContext('2d');
                 const xzCtx=document.getElementById('xzBubbleChart')?.getContext('2d');
                 let success=true;
                 const initialBubblePoint = {x:0, y:0, r: convertRadiusToPlotlySize(MIN_RADIUS)};

                 const yxOptions=commonBubbleOptions('Y','X',0,ROOM_SIZE,0,ROOM_SIZE);
                 yxOptions.plugins.tooltip.callbacks.label = tooltipCallback;
                 if(yxCtx) yxBubbleChart=new Chart(yxCtx,{type:'bubble',data:{datasets:[{label:'YX',data:[initialBubblePoint],backgroundColor:bubbleColorX,borderColor:bubbleBorderColor}]},options:yxOptions});
                 else {console.error("yxBubbleChart canvas not found"); success=false;}

                 const zyOptions=commonBubbleOptions('Z','Y',0,ROOM_SIZE,0,ROOM_SIZE);
                 zyOptions.plugins.tooltip.callbacks.label = tooltipCallback;
                 if(zyCtx) zyBubbleChart=new Chart(zyCtx,{type:'bubble',data:{datasets:[{label:'ZY',data:[initialBubblePoint],backgroundColor:bubbleColorY,borderColor:bubbleBorderColor}]},options:zyOptions});
                 else {console.error("zyBubbleChart canvas not found"); success=false;}

                 const xzOptions=commonBubbleOptions('X','Z',0,ROOM_SIZE,0,ROOM_SIZE);
                 xzOptions.plugins.tooltip.callbacks.label = tooltipCallback;
                 if(xzCtx) xzBubbleChart=new Chart(xzCtx,{type:'bubble',data:{datasets:[{label:'XZ',data:[initialBubblePoint],backgroundColor:bubbleColorZ,borderColor:bubbleBorderColor}]},options:xzOptions});
                 else {console.error("xzBubbleChart canvas not found"); success=false;}

                 return success;
            }

            function initPlotly3D() {
                const radarDiv = document.getElementById('radar3D');
                if (!radarDiv || typeof Plotly === 'undefined') {
                    console.error("Plotly container or library not found.");
                    return false;
                }
                try {
                    const origin = { x: 0, y: 0, z: 0 };
                    let initX = 0, initY = 0, initZ = 0;
                    let initMarkerSize = convertRadiusToPlotlySize(MIN_RADIUS);

                    const radarTrace = {
                        x: [initX], y: [initY], z: [initZ],
                        mode: 'markers',
                        marker: { size: initMarkerSize, color: 'red' },
                        type: 'scatter3d', name: 'Radar'
                    };

                    const originTrace = {
                        x: [origin.x], y: [origin.y], z: [origin.z],
                        mode: 'markers+text',
                        marker: